{% extends "admin/base.html" %}

{% block title %}Admin - User Projects{% endblock %}

{% block header %}User Projects{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title">Projects for {{ user.fields['User Name'] }}</h5>
                    <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">Back to Users</a>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>Slack ID:</strong> {{ user.fields['Slack ID'] }}</p>
                        <p><strong>Email:</strong> {{ user.fields['Email'] }}</p>
                        <p>
                            <strong>Admin Status:</strong> 
                            {% if user.fields['Is Admin'] == 'true' or user.fields['Is Admin'] == True %}
                                <span class="badge bg-success">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary">User</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">User's Projects</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Created</th>
                                <th>Logs</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if projects %}
                                {% for project in projects %}
                                    <tr>
                                        <td>{{ project.fields['Project Name'] }}</td>
                                        <td>
                                            {% if project.fields['Created At'] %}
                                                {{ project.fields['Created At']|string|replace('T', ' ')|truncate(16, True, '') }}
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary" id="log-count-{{ project.id }}">Loading...</span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('admin_project_detail', record_id=project.id) }}" class="btn btn-sm btn-primary">da deets</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No projects found for this user</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch log counts for each project
        {% if projects %}
            {% for project in projects %}
                fetchLogCount('{{ project.id }}', '{{ project.fields["Project Name"] }}');
            {% endfor %}
        {% endif %}
    });
    
    function fetchLogCount(projectId, projectName) {
        fetch(`/api/admin/projects/${projectId}/log-count`)
            .then(response => response.json())
            .then(data => {
                const countElement = document.getElementById(`log-count-${projectId}`);
                if (countElement) {
                    countElement.textContent = data.count;
                }
            })
            .catch(error => {
                console.error(`Error fetching log count for project ${projectName}:`, error);
                const countElement = document.getElementById(`log-count-${projectId}`);
                if (countElement) {
                    countElement.textContent = 'Error';
                    countElement.classList.remove('bg-primary');
                    countElement.classList.add('bg-danger');
                }
            });
    }
</script>
{% endblock %}