{% extends "base.html" %}

{% block title %}Settings - Groundplane{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto fade-in">
    <form id="settings-form" method="POST" action="{{ url_for('save_settings') }}" class="relative z-10">
        <!-- Static Props Toggle Section -->
        <div class="glass-card p-8 mb-8 animate__animated animate__fadeIn relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-gradient-to-r from-blue-500/20 via-cyan-500/20 to-green-500/20 animate-gradient"></div>
            <div class="absolute top-0 left-0 w-40 h-40 bg-blue-400/10 rounded-full -translate-x-20 -translate-y-20 blur-xl animate-pulse"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-green-400/10 rounded-full translate-x-16 translate-y-16 blur-xl animate-pulse"></div>
            
            <div class="flex items-center gap-3 mb-2 relative z-10">
                <div class="relative">
                    <i class='bx bx-data text-blue-400 text-3xl animate-pulse'></i>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-blue-400 rounded-full animate-ping"></div>
                </div>
                <h1 class="text-3xl font-bold text-white bg-gradient-to-r from-blue-400 via-cyan-400 to-green-400 bg-clip-text text-transparent animate-gradient">
                    Data Management
                </h1>
            </div>
            <p class="text-gray-300 mt-2 text-lg relative z-10">Optimize your Airtable API usage</p>
            
            <div class="mt-6 flex justify-between items-center">
                <button id="refresh-data-btn" class="btn-secondary px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 shadow-lg hover:shadow-blue-500/25 transform hover:scale-105 transition-all duration-300" type="button">
                    <i class='bx bx-refresh'></i> Refresh Data
                </button>
                
                <div class="flex items-center gap-4">
                    <span class="text-gray-300">Use Static Data</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <!-- Use only a hidden input for the actual form submission -->
                        <input type="hidden" id="use_static_props" name="use_static_props" value="{% if user_settings.use_static_props %}on{% else %}off{% endif %}">
                        <!-- Visual toggle that updates the hidden input -->
                        <div id="use_static_props_toggle" class="w-14 h-7 bg-slate-700 rounded-full relative after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all {% if user_settings.use_static_props %}bg-gradient-to-r from-blue-500 to-green-500 after:translate-x-full{% endif %}"></div>
                    </label>
                </div>
            </div>
            
            <div id="static-props-info" class="mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50 {% if not user_settings.use_static_props %}hidden{% endif %}">
                <p class="text-gray-300 text-sm">Static data mode is <span class="text-green-400 font-semibold">enabled</span>. Your data is cached locally to reduce Airtable API calls.</p>
                <p class="text-gray-400 text-xs mt-2">Last refreshed: <span id="last-refreshed-time">Never</span></p>
            </div>
        </div>
        <div class="glass-card p-8 mb-8 animate__animated animate__fadeIn relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-gradient-to-r from-orange-500/20 via-red-500/20 to-purple-500/20 animate-gradient"></div>
            <div class="absolute top-0 left-0 w-40 h-40 bg-orange-400/10 rounded-full -translate-x-20 -translate-y-20 blur-xl animate-pulse"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-purple-400/10 rounded-full translate-x-16 translate-y-16 blur-xl animate-pulse"></div>
            
            <div class="flex items-center gap-3 mb-2 relative z-10">
                <div class="relative">
                    <i class='bx bx-cog text-orange-400 text-3xl animate-pulse'></i>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-orange-400 rounded-full animate-ping"></div>
                </div>
                <h1 class="text-3xl font-bold text-white bg-gradient-to-r from-orange-400 via-red-400 to-purple-400 bg-clip-text text-transparent animate-gradient">
                    Settings
                </h1>
            </div>
            <p class="text-gray-300 mt-2 text-lg relative z-10">Customize your Groundplane experience</p>
        
            <div class="mt-8">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i class='bx bx-palette text-orange-400'></i> Appearance
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <div>
                            <h3 class="font-semibold text-white">Animations</h3>
                            <p class="text-gray-400 text-sm">Enable or disable UI animations</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_animations" name="enable_animations" class="sr-only peer" {% if user_settings.enable_animations %}checked{% endif %}>
                            <div class="w-14 h-7 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-500"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-8">
                <a href="{{ url_for('index') }}" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 transition-all duration-300 shadow-lg hover:shadow-slate-500/25 transform hover:scale-105 no-underline">
                    <i class='bx bx-arrow-back'></i> Back to Dashboard
                </a>
                <button type="submit" class="btn-primary px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 shadow-lg hover:shadow-orange-500/25 transform hover:scale-105 transition-all duration-300">
                    <i class='bx bx-save'></i> Save Settings
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const animationsToggle = document.getElementById('enable_animations');
        const staticPropsToggle = document.getElementById('use_static_props_toggle');
        const staticPropsInput = document.getElementById('use_static_props');
        const staticPropsInfo = document.getElementById('static-props-info');
        const refreshDataBtn = document.getElementById('refresh-data-btn');
        const lastRefreshedTime = document.getElementById('last-refreshed-time');
        const settingsForm = document.getElementById('settings-form');
        
        // Handle animations toggle with improved feedback
        if (!animationsToggle.checked) {
            document.body.classList.add('no-animations');
        }
        
        animationsToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.remove('no-animations');
                
                // Provide visual feedback when enabling animations
                const settingsCards = document.querySelectorAll('.glass-card');
                settingsCards.forEach(card => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.transform = 'scale(1.01)';
                    setTimeout(() => {
                        card.style.transform = 'scale(1)';
                    }, 300);
                });
            } else {
                document.body.classList.add('no-animations');
                
                // Provide subtle visual feedback when disabling animations
                const settingsCards = document.querySelectorAll('.glass-card');
                settingsCards.forEach(card => {
                    card.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.2)';
                });
            }
        });
        
        // Handle static props toggle click
        staticPropsToggle.addEventListener('click', function() {
            // Toggle the value
            const isEnabled = staticPropsInput.value === 'on';
            staticPropsInput.value = isEnabled ? 'off' : 'on';
            
            // Update visual state
            if (staticPropsInput.value === 'on') {
                this.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-green-500', 'after:translate-x-full');
                staticPropsInfo.classList.remove('hidden');
            } else {
                this.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-green-500', 'after:translate-x-full');
                staticPropsInfo.classList.add('hidden');
            }
        });
        
        // Add form submit event listener to log form data
        settingsForm.addEventListener('submit', function(e) {
            console.log('Form submitted');
            console.log('use_static_props:', staticPropsInput.value);
            // Don't prevent default - let the form submit normally
        });
        
        // Format the last refreshed time if available
        function updateLastRefreshedTime(timestamp) {
            if (!timestamp) {
                lastRefreshedTime.textContent = 'Never';
                return;
            }
            
            try {
                const date = new Date(timestamp);
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                lastRefreshedTime.textContent = date.toLocaleDateString(undefined, options);
            } catch (e) {
                console.error('Error formatting date:', e);
                lastRefreshedTime.textContent = timestamp;
            }
        }
        
        // Initialize last refreshed time
        {% if user_settings.last_refreshed %}
            updateLastRefreshedTime('{{ user_settings.last_refreshed }}');
        {% endif %}
        
        // Handle refresh data button
        refreshDataBtn.addEventListener('click', function() {
            // Show loading state
            const originalText = refreshDataBtn.innerHTML;
            refreshDataBtn.innerHTML = '<i class="bx bx-loader-alt animate-spin"></i> Refreshing...';
            refreshDataBtn.disabled = true;
            
            // Make API call to refresh data
            fetch('/settings/refresh-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'p-3 bg-green-500/20 text-green-300 rounded-lg mt-4 animate__animated animate__fadeIn';
                    successAlert.innerHTML = '<i class="bx bx-check"></i> Data refreshed successfully!';
                    staticPropsInfo.parentNode.insertBefore(successAlert, staticPropsInfo.nextSibling);
                    
                    // Update last refreshed time
                    updateLastRefreshedTime(data.timestamp);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        successAlert.classList.add('animate__fadeOut');
                        setTimeout(() => successAlert.remove(), 500);
                    }, 3000);
                } else {
                    // Show error message
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'p-3 bg-red-500/20 text-red-300 rounded-lg mt-4 animate__animated animate__fadeIn';
                    errorAlert.innerHTML = `<i class="bx bx-error"></i> ${data.message || 'Error refreshing data'}`;
                    staticPropsInfo.parentNode.insertBefore(errorAlert, staticPropsInfo.nextSibling);
                    
                    // Remove error message after 5 seconds
                    setTimeout(() => {
                        errorAlert.classList.add('animate__fadeOut');
                        setTimeout(() => errorAlert.remove(), 500);
                    }, 5000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show error message
                const errorAlert = document.createElement('div');
                errorAlert.className = 'p-3 bg-red-500/20 text-red-300 rounded-lg mt-4 animate__animated animate__fadeIn';
                errorAlert.innerHTML = '<i class="bx bx-error"></i> Network error. Please try again.';
                staticPropsInfo.parentNode.insertBefore(errorAlert, staticPropsInfo.nextSibling);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    errorAlert.classList.add('animate__fadeOut');
                    setTimeout(() => errorAlert.remove(), 500);
                }, 5000);
            })
            .finally(() => {
                // Restore button state
                refreshDataBtn.innerHTML = originalText;
                refreshDataBtn.disabled = false;
            });
        });
    });
</script>

<style>
    /* Styles for when animations are disabled */
    .no-animations * {
        animation: none !important;
        transition: none !important;
    }
    
    /* Ensure clickable elements remain functional */
    .no-animations button,
    .no-animations a {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 999 !important;
    }
    
    /* Improved hover effects for when animations are disabled */
    .no-animations .glass-card:hover {
        border-color: rgba(255, 255, 255, 0.2) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
        filter: brightness(1.05) !important;
    }
    
    .no-animations button:hover,
    .no-animations a:hover {
        filter: brightness(1.1) !important;
    }
    
    /* Improved focus states for form elements */
    .no-animations input:focus,
    .no-animations select:focus,
    .no-animations textarea:focus {
        outline: 2px solid rgba(255, 140, 55, 0.5) !important;
        box-shadow: 0 0 0 3px rgba(255, 140, 55, 0.25) !important;
    }
</style>
{% endblock %}